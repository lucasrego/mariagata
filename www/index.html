<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="images/apple-touch-icon.png" />
<link rel="apple-touch-startup-image" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" href="apple-touch-startup-image-640x1096.png">
<title>Escovaria e Esmalteria Maria Gata</title>
<link rel="stylesheet" href="css/framework7.css">
<link rel="stylesheet" href="style.css">

<link rel="stylesheet" href="css/colors/grayscale.css">
<link type="text/css" rel="stylesheet" href="css/animations.css" />
<link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,700,900' rel='stylesheet' type='text/css'>


</head>
<body id="mobile_wrap">

    <div class="statusbar-overlay"></div>

    <div class="panel-overlay"></div>

    <div class="panel panel-left panel-cover">
		<div class="user_login_info">
			<!--
			<div class="user_thumb">
				<img src="images/profile.jpg" alt="" title="" />
				<div class="user_details">
					<p>Oi, <span>Juliana</span></p>
				</div>  
				<div class="user_social">
					<a href="#" data-popup=".popup-social" class="open-popup"><img src="images/icons/white/twitter.png" alt="" title="" /></a>
				</div>      
			</div>
			-->
			
			<nav class="user-nav">
				<ul>
					<li><a href="agendar.html"><img src="images/icons/white/esmalte.png" alt="" title="" /><span>Agende seu Momento</span></a></li>
					<li><a href="agendamentos.html"><img src="images/icons/white/blog.png" alt="" title="" /><span>Meus Agendamentos</span><!--<strong class="green">12</strong>--></a></li>
					<li><a href="#" data-popup=".popup-signup" class="open-popup"><img src="images/icons/white/user.png" alt="" title="" /><span>Meu Cadastro</span></a></li>
					<li><a href="#" data-popup=".popup-contato" class="open-popup"><img src="images/icons/white/call.png" alt="" title="" /><span>Contato</span></a></li>
					<li><a href="#" data-popup=".popup-endereco" class="open-popup"><img src="images/icons/white/map.png" alt="" title="" /><span>Como Chegar</span></a></li>
				</ul>
			</nav>
          </div>
    </div>

    
    <div class="views">

      <div class="view view-main">

        <div class="pages toolbar-through">

			<div data-page="index" class="page homepage">
				<div class="page-content">
					<div class="logo"><img src="images/logo.png" alt="" title="" /></div> 
				</div>
			</div>
        </div>
        <!-- MENU INFERIOR -->
        <div class="toolbar">
			<div class="toolbar-inner">
				<ul class="toolbar_icons">
					<li><a href="agendar.html"><img src="images/icons/white/esmalte.png" alt="Agende seu Momento" title="Agende seu Momento" /></a></li>
					<li><a href="agendamentos.html"><img src="images/icons/white/blog.png" alt="Meus Agendamentos" title="Meus Agendamentos" /></a></li>
					<li class="menuicon"><a href="#" data-panel="left" class="open-panel"><img src="images/icons/white/menu.png" alt="" title="" /></a></li>			  
					<li><a href="#" data-popup=".popup-contato" class="open-popup"><img src="images/icons/white/call.png" alt="Contato" title="Agende pelo WhatsApp" /></a></li>
					<li><a href="#" data-popup=".popup-endereco" class="open-popup"><img src="images/icons/white/map.png" alt="Como Chegar" title="Como Chegar" /></a></li>
				</ul>
			</div>  
        </div>
		
      </div>
    </div>
        
	<!-- POPUP: ALTERAR CADASTRO -->
    <div class="popup popup-signup">
		<div class="content-block-login">
		    <div class="form_logo"><img src="images/logo.png" alt="" title="" /></div>
				<h4>INFORME SEUS DADOS</h4>
				<!--<div class="loginform">-->
				<div class="mariagataform">
					<!--<form id="LoginForm" method="post">-->
					<form id="frmCadastro" action="#">
						<input type="text" name="cadastro_nome" id="cadastro_nome" value="" class="form_input required" placeholder="Primeiro Nome" />
						<input type="text" name="cadastro_cpf" id="cadastro_cpf" value="" class="form_input required" placeholder="CPF" />
						<input type="text" name="cadastro_email" id="cadastro_email" value="" class="form_input required" placeholder="E-mail" />
						<input type="text" name="cadastro_celular" id="cadastro_celular" value="" class="form_input required" placeholder="celular (com DDD)" />
						
						<input type="submit" name="submit" class="form_submit" id="submit" value="SALVAR" />
					</form>
				</div>
		  <div class="close_loginpopup_button"><a href="#" class="close-popup"><img src="images/icons/black/menu_close.png" alt="" title="" /></a></div>
		</div>
    </div>

	<!-- POPUP: CONTATO -->
    <div class="popup popup-contato">
		<div class="content-block-login">
		    <div class="form_logo"><img src="images/logo.png" alt="" title="" /></div>
				<h4>FALE COM A MARIA GATA</h4>
				
		  <div class="close_loginpopup_button"><a href="#" class="close-popup"><img src="images/icons/black/menu_close.png" alt="" title="" /></a></div>
		</div>
    </div>
	
	
	<!-- POPUP: ENDEREÇO -->
    <div class="popup popup-endereco">
		<div class="content-block-login">
		    <div class="form_logo"><img src="images/logo.png" alt="" title="" /></div>
				<h4>COMO CHEGAR</h4>
				
		  <div class="close_loginpopup_button"><a href="#" class="close-popup"><img src="images/icons/black/menu_close.png" alt="" title="" /></a></div>
		</div>
    </div>

<script type="text/javascript" src="js/jquery-1.10.1.min.js"></script>
<script src="js/jquery.validate.min.js" type="text/javascript"></script>
<script type="text/javascript" src="js/framework7.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/jquery.fitvids.js"></script>


<script>
	
	
	
	$( document ).ready(function() {
		
		document.addEventListener("deviceready", onDeviceReady, false);
		function onDeviceReady() {
			
			//Local Notification: https://github.com/katzer/cordova-plugin-local-notifications/wiki
			//cordova.plugins.notification.local.schedule({
			//	title: "Lembrete Maria Gata",
			//	message: "Oi, está lembrada do seu agendamento na Maria Gata? Esperamos você lá!! Se não puder comparecer, não deixe de nos avisar, ok?! ;)."
			//});
			
			dadosUsuario = "";
			navigator.vibrate(1000); 
						
			// Initialize your app
			var myApp = new Framework7({
				cache: false,
				animateNavBackIcon: true,
				// Enable templates auto precompilation
				precompileTemplates: true,
				// Enabled pages rendering using Template7
				swipeBackPage: false,
				swipeBackPageThreshold: 1,
				swipePanel: "left",
				sortable: false,
				swipePanelCloseOpposite: true,
				pushState: false,
				template7Pages: true,
				modalTitle: 'Maria Gata',
				modalButtonOk: 'Ok',
				modalButtonCancel: 'Cancelar',
				//smartSelectSearchbar: true,
				//smartSelectInPopup: true,
				//hideTabbarOnPageScroll: true,
				preroute: function (view, options) {
					//alert(options.url); 
					//Testa Internet e Dados usuário antes de onPageInit
					var internet = false;
					if (options.url === 'agendamentos.html') {						
						internet = checkConnection();
						if (internet == false) {
							myApp.alert('Verifique sua internet. Precisamos dela para acessar a Maria Gata! ;)', 'Ops!', function () {
								//mainView.router.loadPage("index.html");
								return false;								
							});						
						} else {
							if (dadosUsuario == "") {
								myApp.popup('.popup-signup');
								return false;			
							}
						}
					}
					if (options.url === 'agendar.html') {						
						internet = checkConnection();
						if (internet == false) {							
							myApp.alert('Verifique sua internet. Precisamos dela para acessar a Maria Gata! ;)', 'Ops!', function () {
								//mainView.router.loadPage("index.html");
								return false;
							});
						}
					}				
				}
			});

			var $$ = Dom7;

			var mainView = myApp.addView('.view-main', {
				dynamicNavbar: false
			});
			
			//http://www.html5rocks.com/en/tutorials/file/filesystem/
			window.requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
			
			function errorHandler(e) {
				myApp.hidePreloader();
				var msg = "";
				switch (e.code) {
					case FileError.QUOTA_EXCEEDED_ERR:
						msg = 'ESPAÇO EM DISCO NÃO DISPONÍVEL';
						break;
					case FileError.NOT_FOUND_ERR:
						dadosUsuario = "";
						msg = "";
						break;
					case FileError.SECURITY_ERR:
						msg = 'ERRO DE SEGURANÇA';
						break;
					case FileError.INVALID_MODIFICATION_ERR:
						msg = 'ERRO DE MODIFICAÇÃO';
						break;
					case FileError.INVALID_STATE_ERR:
						msg = 'ERRO DE ESTADO';
						break;
					default:
						msg = 'ERRO DESCONHECIDO';
						break;
				};
				if (msg != "") {
					myApp.alert('Não conseguimos acessar seu aparelho para salvar dados. [' + msg + ']', 'FALHA');
				}
			}
			
			function salvarDadosArquivo(valor) {
				
				//Antecipa preenchimento dos dadosUsuario, pois a escrita e leitura são assíncronas
				dadosUsuario = valor;
				
				//Preenche campos do popup singup
				$("#cadastro_cpf").val(dadosUsuario.split("|")[0]);
				$("#cadastro_nome").val(dadosUsuario.split("|")[1]);
				$("#cadastro_email").val(dadosUsuario.split("|")[2]);
				$("#cadastro_celular").val(dadosUsuario.split("|")[3]);
				
				window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(filesystem) {
					filesystem.root.getFile('mariagata.txt', {create: true}, function(fileEntry) {
						fileEntry.createWriter(function(writer) {
							writer.write(valor);							
						}, errorHandler);
					}, errorHandler);
				}, errorHandler);
			}
			
			function lerDadosArquivo() {
				myApp.showPreloader('Acessando dados do dispositivo...');
				window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(filesystem) {
					filesystem.root.getFile('mariagata.txt', null, function(fileEntry) {
						fileEntry.file(function(file) {
							var reader = new FileReader();
							reader.onloadend = function(evt) {
								myApp.hidePreloader();
								dadosUsuario = evt.target.result;
								
								//Preenche campos do popup singup
								$("#cadastro_cpf").val(dadosUsuario.split("|")[0]);
								$("#cadastro_nome").val(dadosUsuario.split("|")[1]);
								$("#cadastro_email").val(dadosUsuario.split("|")[2]);
								$("#cadastro_celular").val(dadosUsuario.split("|")[3]);
							};
							reader.readAsText(file);
						}, errorHandler);
					}, errorHandler);
				}, errorHandler);
			}
			
			//Lê dados do usuário, pois é assíncrono e pode demorar um pouco no momento do acesso.
			//salvarDadosArquivo("80941818500|Lucas|lucasrego@gmail.com|7188145976");
			lerDadosArquivo();
			
			function checkConnection() {
					
				var networkState = navigator.connection.type;
				
				var states = {};
				
				states[Connection.UNKNOWN]  = 'Unknown connection';
				states[Connection.ETHERNET] = 'Ethernet connection';
				states[Connection.WIFI]     = 'WiFi connection';
				states[Connection.CELL_2G]  = 'Cell 2G connection';
				states[Connection.CELL_3G]  = 'Cell 3G connection';
				states[Connection.CELL_4G]  = 'Cell 4G connection';
				states[Connection.CELL]     = 'Cell generic connection';
				states[Connection.NONE]     = 'No network connection';
				
				//alert('states[networkState]: ' + states[networkState]);
				//alert('states[Connection.NONE]: ' + states[Connection.NONE]);
				 
				if (states[networkState] == states[Connection.NONE]) {
					return false;
				} else {
					return states[networkState];
				}
				
			}
						
			myApp.onPageInit('agendar', function (page) {
				
				//Obter servicos filial
				$.ajax({
					url: "http://mariagata.com.br/sistema/mariagata.php",
					type: 'POST',
					data: {
						a: 'obterservicosfilial',
						filial: $('#cmbFilial').val()
					},
					beforeSend: function( xhr ) {
						myApp.showPreloader('Consultando serviços disponíveis...');
						//Se precisar alterar xhr: xhr.overrideMimeType( "text/plain; charset=x-user-defined" );
					},
					context: document.body
					
				})
				.always(function() {		
					myApp.hidePreloader(); 			
				})
				.fail(function(jqXHR, textStatus, errorThrown) {
					myApp.alert('Desculpe! Ocorreu um erro inesperado. Por favor, feche e abra novamente o APP ou entre em contato pelo Whatsapp Maria Gata: 71 8879-1014.', 'Maria Gata');
				})
				.done(function(ret) {
					
					//Teste se o objeto retornao é JSON, ou seja, existem dados
					var jsonRetorno = jQuery.parseJSON(ret);
					
					//Se o JSON não tiver a opção resultado é porque 1 ou mais condomínios foram retornados
					if (typeof jsonRetorno.resultado === "undefined") {
						
						//Limpa o option padrão. Caso não tenha o padrão, os itens selecionados não ficam visíveis ao voltar na tela (apenas no celular).
						$('#cmbListaServicos option[value="0"]').remove();
						
						//adiciona os serviços e pacotes
						$.each(jsonRetorno, function( index, value ) {
							
							if (value.SERV_Tipo == "PA") {
								//myApp.smartSelectAddOption($$('.smart-select select optigroup').eq(1), '<option value="' + value.SERV_ID + '">' + value.SERV_Nome + '</option>', 0); 
								//myApp.smartSelectAddOption('.smart-select select ', '<option data-option-color="black" value="' + value.SERV_Nome + '">' + value.SERV_Nome + '</option>');
								$("#cmbListaServicosPacotes").append('<option data-option-color="black" value=' + value.SERV_ID + '>' + value.SERV_Nome + '</option>');
							}
							if (value.SERV_Tipo == "EC") {
								//myApp.smartSelectAddOption($$('.smart-select select optigroup').eq(1), '<option value="' + value.SERV_ID + '">' + value.SERV_Nome + '</option>', 0); 
								//myApp.smartSelectAddOption('.smart-select select ', '<option data-option-color="black" value="' + value.SERV_Nome + '">' + value.SERV_Nome + '</option>');
								$("#cmbListaServicosEscovaria").append('<option data-option-color="black" value=' + value.SERV_ID + '>' + value.SERV_Nome + '</option>');
							}
							if (value.SERV_Tipo == "EM") {
								//myApp.smartSelectAddOption($$('.smart-select select optigroup').eq(1), '<option value="' + value.SERV_ID + '">' + value.SERV_Nome + '</option>', 0); 
								//myApp.smartSelectAddOption('.smart-select select ', '<option data-option-color="black" value="' + value.SERV_Nome + '">' + value.SERV_Nome + '</option>');
								$("#cmbListaServicosEsmalteria").append('<option data-option-color="black" value=' + value.SERV_ID + '>' + value.SERV_Nome + '</option>');
							}
							if (value.SERV_Tipo == "MA") {
								//myApp.smartSelectAddOption($$('.smart-select select optigroup').eq(1), '<option value="' + value.SERV_ID + '">' + value.SERV_Nome + '</option>', 0); 
								//myApp.smartSelectAddOption('.smart-select select ', '<option data-option-color="black" value="' + value.SERV_Nome + '">' + value.SERV_Nome + '</option>');
								$("#cmbListaServicosMaquiagem").append('<option data-option-color="black" value=' + value.SERV_ID + '>' + value.SERV_Nome + '</option>');
							}
							if (value.SERV_Tipo == "DE") {
								//myApp.smartSelectAddOption($$('.smart-select select optigroup').eq(1), '<option value="' + value.SERV_ID + '">' + value.SERV_Nome + '</option>', 0); 
								//myApp.smartSelectAddOption('.smart-select select ', '<option data-option-color="black" value="' + value.SERV_Nome + '">' + value.SERV_Nome + '</option>');
								$("#cmbListaServicosDepilacao").append('<option data-option-color="black" value=' + value.SERV_ID + '>' + value.SERV_Nome + '</option>');
							}							
						});
					} else {			
						if (jsonRetorno.resultado == 'NAOENCONTRADO') {			
							myApp.alert(jsonRetorno.mensagem, 'Maria Gata');				
						} else {
							myApp.alert(jsonRetorno.mensagem, 'Maria Gata');
						}			
					}	
				}); //Fim ajax

			}); //Fim onPageInit agendar
						
			//Variaveis globais
			filial = "";
			servicos = "";
			data = "";
			servicosnome = "";

			//Evento de clique no botão de pesquisar horários
			$$(document).on('click', '#btnVerHorarios', function (e) {
	
				filial = $('#cmbFilial').val();
				data = $('#data_agendamento').val();
				
				servicos = "";
				servicosnome = "";
				
				/*
				//Combo multiselect
				$('#cmbListaServicos').find('option:checked').each(function(index, value){
					servicos += this.value;
					servicosnome += this.text;
					if (index != $('#cmbListaServicos option:checked').length - 1) {
						servicosnome += ", ";
						servicos += ",";
					}
				})
				*/
				
				if ($('#cmbListaServicosPacotes').val() != 0) {
					servicos += $('#cmbListaServicosPacotes').val() + ",";
					servicosnome += $("#cmbListaServicosPacotes option:selected").text() + ", ";				
				}
				if ($('#cmbListaServicosEsmalteria').val() != 0) {
					servicos += $('#cmbListaServicosEsmalteria').val() + ",";
					servicosnome += $("#cmbListaServicosEsmalteria option:selected").text() + ", ";
				}
				if ($('#cmbListaServicosEscovaria').val() != 0) {
					servicos += $('#cmbListaServicosEscovaria').val() + ",";
					servicosnome += $("#cmbListaServicosEscovaria option:selected").text() + ", ";
				}
				if ($('#cmbListaServicosMaquiagem').val() != 0) {
					servicos += $('#cmbListaServicosMaquiagem').val() + ",";
					servicosnome += $("#cmbListaServicosMaquiagem option:selected").text() + ", ";
				}
				if ($('#cmbListaServicosDepilacao').val() != 0) {
					servicos += $('#cmbListaServicosDepilacao').val() + ",";
					servicosnome += $("#cmbListaServicosDepilacao option:selected").text() + ", ";
				}
				
				if (filial != 1) {
					event.preventDefault();
					myApp.alert('Selecione a unidade Maria Gata onde quer ser atendida.', 'Maria Gata');
					return false;
				}
				if (data == "") {
					event.preventDefault();
					myApp.alert('Escolha a data do agendamento.', 'Maria Gata');
					return false;
				}
				if (servicos == "") {
					event.preventDefault();
					myApp.alert('Nenhum pacote ou serviço selecionado.', 'Maria Gata');
					return false;			
				} else {
					//Remove vírgula para servico e virgula + espaço para servicosnome
					servicos = servicos.substring(0,(servicos.length - 1)).toString();
					servicosnome = servicosnome.substring(0,(servicosnome.length - 2)).toString();
				}
				
				temEscovaria = false;
				temEsmalteria = false;
				temMaquiagem = false;
				temDepilacao = false;
				
				//Consultar disponibilidade de profissionais e os horário livres
				$.ajax({
					url: "http://mariagata.com.br/sistema/mariagata.php",
					type: 'POST',
					data: {
						a: 'obterprofissionaishorarios',
						filial: filial,
						data: data,
						servicos: servicos
					},
					beforeSend: function( xhr ) {
						myApp.showPreloader('Consultando disponibilidade dos profissionais...');
						//Se precisar alterar xhr: xhr.overrideMimeType( "text/plain; charset=x-user-defined" );
					},
					context: document.body
					
				})
				.always(function() {		
					myApp.hidePreloader(); 			
				})
				.fail(function(jqXHR, textStatus, errorThrown) {
					myApp.alert('Desculpe! Ocorreu um erro inesperado. Por favor, feche e abra novamente o APP ou entre em contato pelo Whatsapp Maria Gata: 71 8879-1014.', 'Maria Gata');
				})
				.done(function(ret) {
					
					//Teste se o objeto retornao é JSON, ou seja, existem dados
					var jsonRetorno = jQuery.parseJSON(ret);
					
					//Se o JSON não tiver a opção resultado é porque 1 ou mais condomínios foram retornados
					if (typeof jsonRetorno.resultado === "undefined") {
						
						var newPageHorarios = 	'<div class="pages">' +
													'<div data-page="horarios" class="page">' +
														'<div class="page-content">' +
															'<h2 class="page_title">Profissionais e Horários</h2>';
						
						var ultimoGrupo = "";
						var ultimoFuncionario = "";
						var totalItens = jsonRetorno.length;
						var lsHTML = "";
						var classeBotao = "";
						var idBotao = "";
						var classeBotaoDisponivel = "";
						var divGrupo = "";
						var qtdHorariosProfissional = 0;
						var horario = "";
						
						$.each(jsonRetorno, function( index, value ) {
							//{"FUNC_ID":"1","FUNC_Nome":"Tati","FUHB_Horario":"09:00:00","FUHB_HorarioBloqueado":"N","GSER_ID":"1",", FUNC_Especialidade":"Manicure e Art Designer"}
							
							//Transforma de 09:30:00 para 09:30
							horario = value.FUHB_Horario.substring(0,(value.FUHB_Horario.length - 3));
												
							//Obtem e seta a div correspondente ao grupo
							if (value.GSER_ID == 1) {
								divGrupo = $('#cardEsmalteria');
								classeBotao = "btnEsmalteria";
								classeBotaoDisponivel = "btnEsmalteriaDisponivel";
								temEsmalteria = true;						
							} else if (value.GSER_ID == 2) {
								divGrupo = $('#cardEscovaria');
								classeBotao = "btnEscovaria";
								classeBotaoDisponivel = "btnEscovariaDisponivel";
								temEscovaria = true;						
							} else if (value.GSER_ID == 3) {
								divGrupo = $('#cardMaquiagem');
								classeBotao = "btnMaquiagem";
								classeBotaoDisponivel = "btnMaquiagemDisponivel";
								temMaquiagem = true;
							} else {
								divGrupo = $('#cardDepilacao');
								classeBotao = "btnDepilacao";
								classeBotaoDisponivel = "btnDepilacaoDisponivel";
								temDepilacao = true;
							}
							
							idBotao = value.FUNC_Nome + "|" + value.FUNC_ID + "|" + horario;
							
							//Se novo funcionário
							//vazio - 2, 2-2..., 2-1, 1-1, 1-3, 3-3...
							if (ultimoFuncionario != value.FUNC_ID) {
								
								qtdHorariosProfissional = 1;
								
								if (index != 0) {
									//Se não for o primeiro registro, fecha o anterior
									//newPageHorarios += "</p>";
									
									//Os botões serão agrupados 4 por linha (25%). A cada grupo de 4, fecha e reabre a DIV class='row'
									//if ((index == 0)||(index == 4)||(index == 8)||(index == 12)||(index == 16)||(index == 20)||(index == 24)||(index == 28)||(index == 32)) {
									if ((qtdHorariosProfissional == 1)||(qtdHorariosProfissional == 5)||(qtdHorariosProfissional == 9)||(qtdHorariosProfissional == 13)||(qtdHorariosProfissional == 17)||(qtdHorariosProfissional == 21)||(qtdHorariosProfissional == 25)||(qtdHorariosProfissional == 29)||(qtdHorariosProfissional == 33)) {
										newPageHorarios += "</div>";
									}
									newPageHorarios += "</div>";
									newPageHorarios += "</div>";	  
									newPageHorarios += "</div>";
									//newPageHorarios += "</div>";
								}
								
								//Se mudou de grupo, insere cabeçalho do grupo:
								if (ultimoGrupo != value.GSER_ID) {					
									if (value.GSER_ID == "1") {
										newPageHorarios += "<div class='content-block-title'>ESMALTERIA: Escolha profissional e horário</div>";								
									} else if (value.GSER_ID == "2") {
										newPageHorarios += "<div class='content-block-title'>ESCOVARIA: Escolha profissional e horário</div>";								
									} else if (value.GSER_ID == "3") {
										newPageHorarios += "<div class='content-block-title'>MAQUIAGEM: Escolha profissional e horário</div>";								
									} else {
										newPageHorarios += "<div class='content-block-title'>DEPILAÇÃO: Escolha profissional e horário</div>";								
									}
								}	
								
								//Abre o novo card e registra o 1º horário
								newPageHorarios += "<div class='card facebook-card'>";
								newPageHorarios += "<div class='card-header'>";
								newPageHorarios += "<div class='facebook-avatar'><img src='images/funcionarios/" + value.FUNC_ID + ".png' width='40' height='40'></div>";
								newPageHorarios += "<div class='facebook-name'><b>" + value.FUNC_Nome + "</b></div>";
								newPageHorarios += "<div class='facebook-date'>" + value.FUNC_Especialidade + "</div>";
								newPageHorarios += "</div>";
								newPageHorarios += "<div class='card-content'>";
								newPageHorarios += "<div class='card-content-inner'>";
								//newPageHorarios += "<p class='buttons-row theme-pink'>";
								
								//Os botões serão agrupados 4 por linha (25%). A cada grupo de 4, fecha e reabre a DIV class='row'							
								if ((qtdHorariosProfissional == 1)||(qtdHorariosProfissional == 5)||(qtdHorariosProfissional == 9)||(qtdHorariosProfissional == 13)||(qtdHorariosProfissional == 17)||(qtdHorariosProfissional == 21)||(qtdHorariosProfissional == 25)||(qtdHorariosProfissional == 29)||(qtdHorariosProfissional == 33)) {
									newPageHorarios += "<div class='row'>";
								}
								
								if (value.FUHB_HorarioBloqueado == "N") {
									newPageHorarios += "<div class='col-25'><a href='#' id='" + idBotao + "' class='button " + classeBotaoDisponivel + " " + classeBotao + "'>" + horario + "</a></div>";
								} else {
									newPageHorarios += "<div class='col-25'><a href='#' id='" + idBotao + "' class='button " + classeBotao + "' disabled>" + horario + "</a></div>";
								}
							} else {
								
								qtdHorariosProfissional = qtdHorariosProfissional + 1;						
								
								//Se o mesmo funcionário, insere apenas um horário novo
								if (value.FUHB_HorarioBloqueado == "N") {
									newPageHorarios += "<div class='col-25'><a href='#' id='" + idBotao + "' class='button " + classeBotaoDisponivel + " " + classeBotao + "'>" + horario + "</a></div>";
								} else {
									newPageHorarios += "<div class='col-25'><a href='#' id='" + idBotao + "' class='button btnHorario " + classeBotao + "' disabled>" + horario + "</a></div>";
								}					
							}
							
							if (index == totalItens - 1) {
								//Último item
								//Os botões serão agrupados 4 por linha (25%). A cada grupo de 4, fecha e reabre a DIV class='row'							
								if ((qtdHorariosProfissional == 1)||(qtdHorariosProfissional == 5)||(qtdHorariosProfissional == 9)||(qtdHorariosProfissional == 13)||(qtdHorariosProfissional == 17)||(qtdHorariosProfissional == 21)||(qtdHorariosProfissional == 25)||(qtdHorariosProfissional == 29)||(qtdHorariosProfissional == 33)) {
									newPageHorarios += "</div>";
								}
								newPageHorarios += "</div>";
								newPageHorarios += "</div>";	  
								newPageHorarios += "</div>";						
							}
							
							//divGrupo.append(lsHTML);
							
							ultimoGrupo = value.GSER_ID;
							ultimoFuncionario = value.FUNC_ID;
							
						});
						
						newPageHorarios += 	'</div>' +
											'<div class="content-block">' +
												'<div class="row">' +
													  '<div class="col-50">' +
														'<a href="agendar.html" class="button button-fill color-red button-round">Nova Pesquisa</a>' +
													  '</div>' +
													  '<div class="col-50">' +
														'<a href="#" id="btnConcluirAgendamento" class="button button-fill color-green button-round">Agendar</a>' +
													  '</div>' +
													'</div>' +										
												'</div>' +
											'</div>' +
										'</div>' +
									'</div>';

						mainView.router.load({
							content: newPageHorarios,
							animatePages: false
						});
										
						//console.log("html Pagina: " + newPageHorarios);
						
					} else {			
						if (jsonRetorno.resultado == 'NAOENCONTRADO') {			
							myApp.alert(jsonRetorno.mensagem, 'Maria Gata');				
						} else {
							myApp.alert(jsonRetorno.mensagem, 'Maria Gata');
						}
					}
					
				}); //Fim ajax obterprofissionaishorarios
						
			}); //Fim #btnVerHorarios.click

			
			myApp.onPageInit('agendamentos', function (page) {
				
				cpf_BD = dadosUsuario.split("|")[0];
				
				//obteragendamentoscliente
				$.ajax({
					url: "http://mariagata.com.br/sistema/mariagata.php",
					type: 'POST',
					data: {
						a: 'obteragendamentoscliente',
						cpf: cpf_BD
					},
					beforeSend: function( xhr ) {
						myApp.showPreloader('Obtendo seus agendamentos...');
						//Se precisar alterar xhr: xhr.overrideMimeType( "text/plain; charset=x-user-defined" );
					},
					context: document.body
					
				})
				.always(function() {		
					myApp.hidePreloader(); 			
				})
				.fail(function(jqXHR, textStatus, errorThrown) {
					myApp.alert('Desculpe! Ocorreu um erro inesperado. Por favor, feche e abra novamente o APP ou entre em contato pelo Whatsapp Maria Gata: 71 8879-1014.', 'Maria Gata');
				})
				.done(function(ret) {
					
					//Teste se o objeto retornao é JSON, ou seja, existem dados
					var jsonRetorno = jQuery.parseJSON(ret);
					
					//Se o JSON não tiver a opção resultado é porque 1 ou mais condomínios foram retornados
					if (typeof jsonRetorno.resultado === "undefined") {
						
						var lsHTML = "";
						lsHTML += '<div class="list-block inset"><ul>';
								
						//adiciona os serviços e pacotes
						$.each(jsonRetorno, function( index, value ) {
								
							lsHTML += '<li>';
								lsHTML += '<a href="#" id="agendamento|' + value.AGEN_ID + '" class="item-link item-content botaoDetalharAgendamento">';
									lsHTML += '<div class="item-media">';
									lsHTML += '<i class="icon my-icon"></i>';
									lsHTML += '</div>';
									lsHTML += '<div class="item-inner">';
									lsHTML += '<div class="item-title">' + value.DataFormatada + '</div>';
									//lsHTML += '<div class="item-after">' + value.AGEN_ID + '</div>';
									lsHTML += '</div>';
								lsHTML += '</a>';
							lsHTML += '</li>';

						});
						
						lsHTML += '</ul><div class="list-block-label">Exibindo apenas agendamentos em aberto e confirmados</div></div>';	
						
						$("#listaAgendamentos").append(lsHTML);
						
					} else {			
						if (jsonRetorno.resultado == 'NAOENCONTRADO') {			
							myApp.alert(jsonRetorno.mensagem, 'Maria Gata');				
						} else {
							myApp.alert(jsonRetorno.mensagem, 'Maria Gata');
						}			
					}	
					
				}); //Fim ajax
				
			}); //Fim onPageInit agendamentos


			$$(document).on('click', '.botaoDetalharAgendamento', function (e) {

				var agendamentoId = this.id.split("|")[1];
				
				//obter detalhes do agendamento
				$.ajax({
					url: "http://mariagata.com.br/sistema/mariagata.php",
					type: 'POST',
					data: {
						a: 'obterdetalhesagendamento',
						agendamento: agendamentoId
					},
					beforeSend: function( xhr ) {
						myApp.showPreloader('Obtendo detalhes...');
						//Se precisar alterar xhr: xhr.overrideMimeType( "text/plain; charset=x-user-defined" );
					},
					context: document.body
					
				})
				.always(function() {		
					myApp.hidePreloader(); 			
				})
				.fail(function(jqXHR, textStatus, errorThrown) {
					myApp.alert('Desculpe! Ocorreu um erro inesperado. Por favor, feche e abra novamente o APP ou entre em contato pelo Whatsapp Maria Gata: 71 8879-1014.', 'Maria Gata');
				})
				.done(function(ret) {
					
					//Teste se o objeto retornao é JSON, ou seja, existem dados
					var jsonRetorno = jQuery.parseJSON(ret);
							
					//Se o JSON não tiver a opção resultado é porque 1 ou mais condomínios foram retornados
					if (typeof jsonRetorno.resultado === "undefined") {
						
						var dataAgendamentoDetalhe = "";
						var ultimoFuncionario = "";
						var ultimoServico = "";
						var servicosDetalhe = "";
						var servicosId = "";
						var funcionarioDetalhe = "";
						
						//Prepara as strings de exibição
						$.each(jsonRetorno, function( index, value ) {
							
							dataAgendamentoDetalhe = value.DataAgendamento;
							if (value.FUNC_ID != ultimoFuncionario) {
								funcionarioDetalhe += '<p>' + value.AGFU_HoraInicio + 'h: ' + value.FUNC_Nome + ' (' + value.FUNC_Especialidade + ')</p>';
							}
							
							if (servicosDetalhe.indexOf(value.SERV_Nome) == -1) {
								servicosDetalhe += '<p>' + value.SERV_Nome + '</p>';
							}
							
							ultimoFuncionario = value.FUNC_ID;
							ultimoServico = value.SERV_ID;
							
						}); 
						
						var newPageDetalheAgendamento = 	'<div class="pages">' +
												'<div data-page="detalhesAgendamento" class="page">' +
													'<div class="page-content">' +
														'<h2 class="page_title">Detalhes do Agendamento</h2>';
						
						newPageDetalheAgendamento += 	'<div class="card facebook-card">' +
															'<div class="card-header no-border">' +
																'<div class="facebook-avatar"><img src="images/funcionarios/juliana.png" width="40" height="40"></div>' +
																'<div class="facebook-name">' + dataAgendamentoDetalhe + '</div>' +
																'<div class="facebook-date"></div>' +
															'</div>' +
															'<div class="card-content">' +
															'<div class="card-content-inner">' +
																servicosDetalhe +
																'<p>&nbsp;</p>' +
																funcionarioDetalhe +													
															'</div>' +
															'</div>' +
															'<div class="card-footer no-border">' +
																'<a href="#" class="link">Like</a>' +
																'<a href="#" class="link">Comment</a>' +
																'<a href="#" class="link">Share</a>' +
															'</div>' +
														'</div>' +
														'<div class="content-block">' +
															'<p><a href="#" id="cancelar|' + agendamentoId + '" class="button button-fill color-red button-round btnCancelarAgendamento">Cancelar</a></p>' +
														'</div>' +
													'</div>' +
													'</div>' +
													'</div>';
						
						mainView.router.load({
							content: newPageDetalheAgendamento,
							animatePages: false
						});
						
					} else {			
						if (jsonRetorno.resultado == 'NAOENCONTRADO') {			
							myApp.alert(jsonRetorno.mensagem, 'Maria Gata');				
						} else {
							myApp.alert(jsonRetorno.mensagem, 'Maria Gata');
						}			
					}	
				}); //Fim ajax
				
			});  //Fim click .botaoDetalharAgendamento



			$$(document).on('click', '.btnCancelarAgendamento', function (e) {
				agendamentoCancelarId = this.id.split("|")[1];
				
				myApp.modal({
					title:  'Quer realmente cancelar?',
					text: 'Operação não poderá ser desfeita',
					buttons: [
					  {
						text: 'Não'
					  },
					  {
						text: 'Pode cancelar',
						bold: true,
						onClick: function() {
							
							//Requisição para agendar 
							$.ajax({
								url: "http://mariagata.com.br/sistema/mariagata.php",
								type: 'POST',
								data: {
									a: 'cancelaragendamento',
									agendamento: agendamentoCancelarId						
								},
								beforeSend: function( xhr ) {
									myApp.showPreloader('Cancelando Agendamento...');
								},
								context: document.body
								
							})
							.always(function() {		
								myApp.hidePreloader();
							})
							.fail(function(jqXHR, textStatus, errorThrown) {
								myApp.alert('Desculpe!! Ocorreu um erro inesperado. Por favor, feche e abra novamente o APP ou entre em contato pelo Whatsapp Maria Gata: 71 8879-1014.', 'Maria Gata');
							})
							.done(function(ret) {

								//Teste se o objeto retornao é JSON, ou seja, existem dados
								var jsonRetorno = jQuery.parseJSON(ret);
									
								if (jsonRetorno.resultado == 'SUCESSO') {
									myApp.alert(jsonRetorno.mensagem, 'Maria Gata', function () {
										mainView.router.loadPage("index.html");
									});									
								} else {
									myApp.alert(jsonRetorno.mensagem, 'Maria Gata');
								}			
								
							}); //Fim ajax
						}
					  }
					]
				}); //Fim Modal
				
			});  //Fim click .btnCancelarAgendamento
				
				
			$$(document).on('click', '.btnEsmalteriaDisponivel', function (e) {
				navigator.vibrate(300);
				//Limpa a classe dos botões btnEsmalteriaDisponivel. Se não estiver disabled, aplica css do botão selecionado
				$('.btnEsmalteriaDisponivel').removeClass("btnSelecionado").addClass( "btnEsmalteria" );
				$(e.target).removeClass( "btnEsmalteria" ).addClass( "btnSelecionado" );
			});

			$$(document).on('click', '.btnEscovariaDisponivel', function (e) {
				navigator.vibrate(300);
				//Limpa a classe dos botões btnEscovaria. Se não estiver disabled, aplica css do botão selecionado
				$('.btnEscovariaDisponivel').removeClass("btnSelecionado").addClass( "btnEscovaria" );
				$(e.target).removeClass( "btnEscovaria" ).addClass( "btnSelecionado" );
			});
			
			$$(document).on('click', '.btnMaquiagemDisponivel', function (e) {
				navigator.vibrate(300);
				//Limpa a classe dos botões btnMaquiagem. Se não estiver disabled, aplica css do botão selecionado
				$('.btnMaquiagemDisponivel').removeClass("btnSelecionado").addClass( "btnMaquiagem" );
				$(e.target).removeClass( "btnMaquiagem" ).addClass( "btnSelecionado" );
			});
			
			$$(document).on('click', '.btnDepilacaoDisponivel', function (e) {
				navigator.vibrate(300);
				//Limpa a classe dos botões btnDepilacao. Se não estiver disabled, aplica css do botão selecionado
				$('.btnDepilacaoDisponivel').removeClass("btnSelecionado").addClass( "btnDepilacao" );
				$(e.target).removeClass( "btnDepilacao" ).addClass( "btnSelecionado" );
			});
			
			
			$( "#frmCadastro" ).submit(function( event ) {
				event.preventDefault();
				
				//Valida dados de cadastro
				var cadastro_nome = $.trim($("#cadastro_nome").val());
				var cadastro_cpf = $.trim($("#cadastro_cpf").val());
				var cadastro_email = $.trim($("#cadastro_email").val());
				var cadastro_celular = $.trim($("#cadastro_celular").val()).replace(/\D/g,''); //Replace remove caracteres não numéricos
				
				if (cadastro_nome == "") {
					myApp.alert("Informe seu primeiro nome.", 'Dado obrigatório');
					return false;
				}
				if (cadastro_cpf == "") {
					myApp.alert("Informe o CPF. Com ele sempre identificaremos você no sistema da Maria Gata!", 'Dado obrigatório');
					return false;
				}
				if (cadastro_cpf.length != 11) {
					myApp.alert("Parece que o CPF não está válido. Ele deve possuir 11 dígitos.", 'Ops!');
					return false;
				}
				if (cadastro_email == "") {
					myApp.alert("Informe seu e-mail.", 'Dado obrigatório');
					return false;
				}
				if (cadastro_celular == "") {
					myApp.alert("Informe seu celular com DDD. Com ele poderemos confirmar os agendamentos e nos falar mais facilmente.", 'Dado obrigatório');
					return false;
				}
				if ((cadastro_celular.length != 10)&&(cadastro_celular.length != 11)) {
					myApp.alert("O celular não está válido. Verifique se digitou corretamente com o DDD (Ex: 7199999999).", 'Dado obrigatório');
					return false;
				}
				
				$.ajax({
					url: "http://mariagata.com.br/sistema/mariagata.php",
					type: 'POST',
					data: {
						a: 'salvardadosusuario',
						cpf: cadastro_cpf,
						nome: cadastro_nome,
						email: cadastro_email,
						celular: cadastro_celular
					},
					beforeSend: function( xhr ) {
						myApp.showPreloader('Salvando seus dados...');
					},
					context: document.body
					
				})
				.always(function() {		
					myApp.hidePreloader();
				})
				.fail(function(jqXHR, textStatus, errorThrown) {
					myApp.alert('Desculpe!! Ocorreu um erro inesperado. Por favor, feche e abra novamente o APP ou entre em contato pelo Whatsapp Maria Gata: 71 8879-1014.', 'Maria Gata');
				})
				.done(function(ret) {

					//Teste se o objeto retornao é JSON, ou seja, existem dados
					var jsonRetorno = jQuery.parseJSON(ret);
						
					if (jsonRetorno.resultado == 'SUCESSO') {
						salvarDadosArquivo(cadastro_cpf + "|" + cadastro_nome + "|" + cadastro_email + "|" + cadastro_celular);
						myApp.closeModal(".popup-signup");
						myApp.alert(jsonRetorno.mensagem, 'Maria Gata');						
					} else {
						myApp.alert(jsonRetorno.mensagem, 'Maria Gata');
					}
					
				}); //Fim ajax
				
			}); //Fim frmCadastro submit
			
			
			$$(document).on('click', '#btnConcluirAgendamento', function (e) {
	
				//Se já tiver os dados de login e cadastro no BD, conclui o agendamento. Caso contrário, abre popup de login/cadastro.
				navigator.vibrate(1000);
				
				if (dadosUsuario == "") {
					myApp.alert('Iremos precisar dos seus dados completos para agendar o seu momento, ok?', 'Maria Gata', function () {
						myApp.popup('.popup-signup');
						return false;				
					});
				} else {
					
					cpf_BD = dadosUsuario.split("|")[0];
					
					var IdProfissionalEsmalteria = "";
					var nomeProfissionalEsmalteria = "";
					var horarioEsmalteria = "";
					var IdProfissionalEscovaria = "";
					var nomeProfissionalEscovaria = "";
					var horarioEscovaria = "";
					var msgNaoSelecionado = "";
					var idSelecionadoEsmalteria = "";
					var idSelecionadoEscovaria = "";
					
					if (temEsmalteria) {
						idSelecionadoEsmalteria = $('.btnEsmalteriaDisponivel.btnSelecionado').attr('id');
						if (idSelecionadoEsmalteria === undefined) {
							msgNaoSelecionado = "Selecione um profissional e horário para o(s) serviço(s) da Esmalteria.";
						} else {
							nomeProfissionalEsmalteria = idSelecionadoEsmalteria.split("|")[0];
							IdProfissionalEsmalteria = idSelecionadoEsmalteria.split("|")[1];
							horarioEsmalteria = idSelecionadoEsmalteria.split("|")[2];
						}			
					}
					if (temEscovaria) {
						idSelecionadoEscovaria = $('.btnEscovariaDisponivel.btnSelecionado').attr('id');
						if (idSelecionadoEscovaria === undefined) {
							if ((temEsmalteria)&&((idSelecionadoEsmalteria === undefined)||(idSelecionadoEsmalteria == ""))) {
								msgNaoSelecionado = "Selecione profissionais e horários para o(s) serviço(s) da Esmalteria e Escovaria.";
							} else {
								msgNaoSelecionado = "Selecione um profissional e horário para o(s) serviço(s) da Escovaria.";
							}
						} else {
							nomeProfissionalEscovaria = idSelecionadoEscovaria.split("|")[0];
							IdProfissionalEscovaria = idSelecionadoEscovaria.split("|")[1];
							horarioEscovaria = idSelecionadoEscovaria.split("|")[2];
						}
					}
					
					if (msgNaoSelecionado != "") {
						myApp.alert(msgNaoSelecionado, 'Ops!');
					} else {
						
						var dataExibicao = data.split("-")[2] + "/" + data.split("-")[1] + "/" + data.split("-")[0];
						
						var msgEsmalteria = "";
						if (temEsmalteria) {
							msgEsmalteria = '<p>Esmalteria: ' + nomeProfissionalEsmalteria + ' (' + horarioEsmalteria + 'h)</p>';
						}
						
						var msgEscovaria = "";
						if (temEscovaria) {
							msgEscovaria = '<p>Escovaria: ' + nomeProfissionalEscovaria + ' (' + horarioEscovaria + 'h)</p>';
						}
						
						var dadosAgendamento = '<span>' +
													'<p>Unidade: Maria Gata Pituba</p>' +
													'<p>Serviços: ' + servicosnome + '</p>' +																				
													'<p>Quando: ' + dataExibicao + '</p>' +
													msgEsmalteria +
													msgEscovaria +
												'</span>';

						
						myApp.modal({
							title:  'Revise o agendamento',
							text: dadosAgendamento,
							buttons: [
							  {
								text: 'Vou revisar'
							  },
							  {
								text: 'Pode agendar',
								bold: true,
								onClick: function() {
									
									//Requisição para agendar 
									$.ajax({
										url: "http://mariagata.com.br/sistema/mariagata.php",
										type: 'POST',
										data: {
											a: 'confirmaragendamento',
											cpf: cpf_BD, //preenchido no obterDadosUsuarioBD() no inicio do metodo click.'#btnConcluirAgendamento
											filial: filial,
											data: data,
											servicos: servicos,
											funcionarioEsmalteria: IdProfissionalEsmalteria,
											horarioEsmalteria: horarioEsmalteria,
											funcionarioEscovaria: IdProfissionalEscovaria,
											horarioEscovaria: horarioEscovaria
										},
										beforeSend: function( xhr ) {
											myApp.showPreloader('Confirmando Agendamento...');
										},
										context: document.body
										
									})
									.always(function() {		
										myApp.hidePreloader();
									})
									.fail(function(jqXHR, textStatus, errorThrown) {
										myApp.alert('Desculpe!! Ocorreu um erro inesperado. Por favor, feche e abra novamente o APP ou entre em contato pelo Whatsapp Maria Gata: 71 8879-1014.', 'Maria Gata');
									})
									.done(function(ret) {

										//Teste se o objeto retornao é JSON, ou seja, existem dados
										var jsonRetorno = jQuery.parseJSON(ret);
											
										if (jsonRetorno.resultado == 'SUCESSO') {
											myApp.alert(jsonRetorno.mensagem, 'Parabéns', function () {
												mainView.router.loadPage("index.html");
											});
										} else {
											myApp.alert(jsonRetorno.mensagem, 'Maria Gata');
										}			
										
									}); //Fim ajax
								}
							  }
							]
						}); //Fim Modal
								
					} //Fim if/else msgNaoSelecionado != ""
					
				} //Fim else/if dadosUsuario
				
			}); //Fim btnConcluirAgendamento.click			
			
		} // Fim onDeviceReady()
					
	}); //Fim document.ready()
	
</script>
	

  </body>
</html>